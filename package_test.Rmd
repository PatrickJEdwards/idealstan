---
title: "Package Test"
output:
  html_document: default
  html_notebook: default
---


```{r setup, include=FALSE}

require(idealstan)
require(ggplot2)
require(dplyr)
require(tidyr)
require(rstan)

knitr::opts_chunk$set(fig.align = 'center',warning = F,message = F)
```


##Introduction

This Rmarkdown file has a series of simulations run on the models offered in `idealstan`. It simulates a large amount of data and then checks to see if the residuals relative to the true parameters sum to zero, as well as for credible interval coverage. In general, the credible intervals aren't going to be exactly where they should be because the constraints used in estimating the models and identifying the signs aren't themselves included in the simulated data. I.e., one of the ideal points actually follows a positive continuous distribution instead of a random normal distribution once it is constrained, which introduces a slight bias in the recovery of the true parameters. This is an artifact of virtually every latent variable model, and is not of great concern as long as the credible intervals reach close to 90 percent coverage. 


First, the standard IRT 2-PL (for this one, the absence discriminations are not a part of the model):

```{r irt_binary}
bin_irt_2pl_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=F,absence=F)
bin_irt_2pl_est <- id_estimate(idealdata=bin_irt_2pl_sim,
                               model_type=1,
                               restrict_ind_high = as.character(sort(bin_irt_2pl_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                               restrict_ind_low = as.character(sort(bin_irt_2pl_sim@simul_data$true_person,
                                                                    decreasing=F, 
                                                        index=T)$ix[1]),
                               fixtype='constrained',
                           id_diff = sort(bin_irt_2pl_sim@simul_data$true_person,decreasing=T)[1] -
                             sort(bin_irt_2pl_sim@simul_data$true_person,decreasing=F)[1],
                           nchains=4,ncores=4)
id_plot_rhats(bin_irt_2pl_est)
```

```{r cov_plot_irt_2pl}
id_sim_coverage(bin_irt_2pl_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r irt_2pl_resid}

id_plot_sims(bin_irt_2pl_est,type='Residuals')

```

```{r irt_2pl_RMSE}

id_plot_sims(bin_irt_2pl_est)

```


Next, inflated 2-PL IRT (binary):

```{r irt_binary_inflate}
bin_irt_2pl_abs_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=F,absence=T,
                               absence_diff_mean=0)
bin_irt_2pl_abs_est <- id_estimate(idealdata=bin_irt_2pl_abs_sim,
                               model_type=2,
                               restrict_ind_high = as.character(sort(bin_irt_2pl_abs_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(bin_irt_2pl_abs_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',
                              id_diff = sort(bin_irt_2pl_abs_sim@simul_data$true_person,decreasing=T)[1] -
                             sort(bin_irt_2pl_abs_sim@simul_data$true_person,decreasing=F)[1])
id_plot_rhats(bin_irt_2pl_abs_est)
```

```{r irt_2pl_abs_cov_plot}
id_sim_coverage(bin_irt_2pl_abs_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r irt_2pl_abs_resid}

id_plot_sims(bin_irt_2pl_abs_est,type='Residuals')

```

```{r irt_2pl_abs_RMSE}

id_plot_sims(bin_irt_2pl_abs_est)

```

Now we'll start with the ordinal models. First the uninflated ordinal model:

```{r irt_ordinal}
ord_irt_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=T,absence=F,
                               absence_diff_mean=0,model_type='ordinal_ratingscale')
ord_irt_est <- id_estimate(idealdata=ord_irt_sim,
                               model_type=3,
                               restrict_ind_high = as.character(sort(ord_irt_sim@simul_data$true_person,decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_sim@simul_data$true_person,decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',
                           id_diff = sort(ord_irt_sim@simul_data$true_person,decreasing=T)[1] -
                             sort(ord_irt_sim@simul_data$true_person,decreasing=F)[1])
id_plot_rhats(ord_irt_est)
```

```{r irt_ord_cov_plot}
id_sim_coverage(ord_irt_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_resid}

id_plot_sims(ord_irt_est,type='Residuals')

```

```{r ord_irt_RMSE}

id_plot_sims(ord_irt_est)

```

And we will finish with the inflated ordinal model:

```{r irt_ordinal_abs}
ord_irt_abs_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=T,absence=T,
                               absence_diff_mean=0,model_type='ordinal_ratingscale')
ord_irt_abs_est <- id_estimate(idealdata=ord_irt_abs_sim,
                               model_type=4,
                               restrict_ind_high = as.character(sort(ord_irt_abs_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_abs_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_abs_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_abs_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_abs_est)
```

```{r ord_irt_abs_cov_plot}
id_sim_coverage(ord_irt_abs_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_abs_resid}

id_plot_sims(ord_irt_abs_est,type='Residuals')

```

```{r ord_irt_abs_RMSE}

id_plot_sims(ord_irt_abs_est)

```

We can now try the ordinal graded response version (non-inflated):

```{r irt_ordinal_grm}
ord_irt_grm_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=T,absence=F,
                               absence_diff_mean=0,model_type='ordinal_grm')
ord_irt_grm_est <- id_estimate(idealdata=ord_irt_grm_sim,
                               model_type=5,
                               restrict_ind_high = as.character(sort(ord_irt_grm_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_grm_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_grm_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_grm_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_grm_est)
```

```{r ord_irt_grm_cov_plot}
id_sim_coverage(ord_irt_grm_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_grm_resid}

id_plot_sims(ord_irt_grm_est,type='Residuals')

```

```{r ord_irt_grm_RMSE}

id_plot_sims(ord_irt_grm_est)

```

And now the inflated GRM:

```{r irt_ordinal_grm_abs}
ord_irt_grm_abs_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=T,absence=T,
                               absence_diff_mean=0,model_type='ordinal_grm')
ord_irt_grm_abs_est <- id_estimate(idealdata=ord_irt_grm_abs_sim,
                               model_type=6,
                               restrict_ind_high = as.character(sort(ord_irt_grm_abs_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_grm_abs_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_grm_abs_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_grm_abs_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_grm_abs_est)
```

```{r ord_irt_grm_abs_cov_plot}
id_sim_coverage(ord_irt_grm_abs_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_grm_abs_resid}

id_plot_sims(ord_irt_grm_abs_est,type='Residuals')

```

```{r ord_irt_grm_abs_RMSE}

id_plot_sims(ord_irt_grm_abs_est)

```

# Additional Models V0.3

Models I am adding to this release include the Poisson model:

```{r irt_ordinal_poisson}
ord_irt_poisson_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=F,absence=F,
                               absence_diff_mean=0,model_type='poisson')
ord_irt_poisson_est <- id_estimate(idealdata=ord_irt_poisson_sim,
                               model_type=7,
                               restrict_ind_high = as.character(sort(ord_irt_poisson_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_poisson_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_poisson_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_poisson_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_poisson_est)
```

```{r ord_irt_poisson_cov_plot}
id_sim_coverage(ord_irt_poisson_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_poisson_resid}

id_plot_sims(ord_irt_poisson_est,type='Residuals')

```

```{r ord_irt_poisson_RMSE}

id_plot_sims(ord_irt_poisson_est)

```


Now Poisson-inflated:

```{r irt_ordinal_poisson}
ord_irt_poisson_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=T,absence=F,
                               absence_diff_mean=0,model_type='poisson')
ord_irt_poisson_est <- id_estimate(idealdata=ord_irt_poisson_sim,
                               model_type=7,
                               restrict_ind_high = as.character(sort(ord_irt_poisson_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_poisson_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_poisson_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_poisson_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_poisson_est)
```

```{r ord_irt_poisson_cov_plot}
id_sim_coverage(ord_irt_poisson_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_poisson_resid}

id_plot_sims(ord_irt_poisson_est,type='Residuals')

```

```{r ord_irt_poisson_RMSE}

id_plot_sims(ord_irt_poisson_est)

```

A Normally-distributed outcome with no inflation:

```{r irt_normal}
ord_irt_normal_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=F,absence=F,
                               absence_diff_mean=0,model_type='normal')
ord_irt_normal_est <- id_estimate(idealdata=ord_irt_normal_sim,
                               model_type=9,
                               restrict_ind_high = as.character(sort(ord_irt_normal_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_normal_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_normal_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_normal_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_normal_est)
```

```{r ord_irt_normal_cov_plot}
id_sim_coverage(ord_irt_normal_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_normal_resid}

id_plot_sims(ord_irt_normal_est,type='Residuals')

```

```{r ord_irt_normal_RMSE}

id_plot_sims(ord_irt_normal_est)

```

A Normally-distributed outcome with inflation:


```{r irt_normal_abs}
ord_irt_normal_abs_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=F,absence=F,
                               absence_diff_mean=0,model_type='normal')
ord_irt_normal_abs_est <- id_estimate(idealdata=ord_irt_normal_abs_sim,
                               model_type=9,
                               restrict_ind_high = as.character(sort(ord_irt_normal_abs_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_normal_abs_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_normal_abs_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_normal_abs_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_normal_abs_est)
```

```{r ord_irt_normal_abs_cov_plot}
id_sim_coverage(ord_irt_normal_abs_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_normal_abs_resid}

id_plot_sims(ord_irt_normal_abs_est,type='Residuals')

```

```{r ord_irt_normal_abs_RMSE}

id_plot_sims(ord_irt_normal_abs_est)

```

A Lognormal model with no inflation:

```{r irt_lognormal}
ord_irt_lognormal_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=F,absence=F,
                               absence_diff_mean=0,model_type='lognormal')
ord_irt_lognormal_est <- id_estimate(idealdata=ord_irt_lognormal_sim,
                               model_type=9,
                               restrict_ind_high = as.character(sort(ord_irt_lognormal_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_lognormal_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_lognormal_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_lognormal_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_lognormal_est)
```

```{r ord_irt_lognormal_cov_plot}
id_sim_coverage(ord_irt_lognormal_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_lognormal_resid}

id_plot_sims(ord_irt_lognormal_est,type='Residuals')

```

```{r ord_irt_lognormal_RMSE}

id_plot_sims(ord_irt_lognormal_est)

```

And last but not least, a lognormal model with inflation:

```{r irt_lognormal_abs}
ord_irt_lognormal_abs_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=F,absence=F,
                               absence_diff_mean=0,model_type='lognormal')
ord_irt_lognormal_abs_est <- id_estimate(idealdata=ord_irt_lognormal_abs_sim,
                               model_type=9,
                               restrict_ind_high = as.character(sort(ord_irt_lognormal_abs_sim@simul_data$true_person,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(ord_irt_lognormal_abs_sim@simul_data$true_person,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',id_diff =sort(ord_irt_lognormal_abs_sim@simul_data$true_person,
                                                                   decreasing=T)[1] -
                                sort(ord_irt_lognormal_abs_sim@simul_data$true_person,
                                  decreasing=F)[1])
id_plot_rhats(ord_irt_lognormal_abs_est)
```

```{r ord_irt_lognormal_abs_cov_plot}
id_sim_coverage(ord_irt_lognormal_abs_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r ord_irt_lognormal_abs_resid}

id_plot_sims(ord_irt_lognormal_abs_est,type='Residuals')

```

```{r ord_irt_lognormal_abs_RMSE}

id_plot_sims(ord_irt_lognormal_abs_est)

```

# Testing for Time

We won't test all the possible time auto-correlation settings, only a subset of them. I use an inflated binary model as it is a very common one. First random walks:

```{r irt_binary_time_inflate}
bin_time_irt_2pl_abs_sim <- id_sim_gen(num_person=20,num_bills=100,ordinal=F,absence=T,
                               absence_diff_mean=0,time_process = 'random',time_points=20)
bin_time_irt_2pl_abs_est <- id_estimate(idealdata=bin_time_irt_2pl_abs_sim,
                               model_type=2,
                               restrict_ind_high = as.character(sort(bin_time_irt_2pl_abs_sim@simul_data$drift,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(bin_time_irt_2pl_abs_sim@simul_data$drift,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',
                              id_diff = sort(bin_time_irt_2pl_abs_sim@simul_data$drift,decreasing=T)[1] -
                             sort(bin_time_irt_2pl_abs_sim@simul_data$drift,decreasing=F)[1],
                             time_sd=10,
                             restrict_sd = 1)
id_plot_rhats(bin_time_irt_2pl_abs_est)
```

```{r irt_2pl_abs_cov_plot}
id_sim_coverage(bin_time_irt_2pl_abs_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r irt_2pl_abs_resid}

id_plot_sims(bin_time_irt_2pl_abs_est,type='Residuals')

```

```{r irt_2pl_abs_RMSE}

id_plot_sims(bin_time_irt_2pl_abs_est)

```

And autocorrelation:

```{r irt_binary_time_ar_inflate}
bin_time_ar_irt_2pl_abs_sim <- id_sim_gen(num_person=20,num_bills=1000,ordinal=F,absence=T,
                               absence_diff_mean=0,time_process = 'AR',time_points=20)
bin_time_ar_irt_2pl_abs_est <- id_estimate(idealdata=bin_time_ar_irt_2pl_abs_sim,
                               model_type=2,
                               restrict_ind_high = as.character(sort(bin_time_ar_irt_2pl_abs_sim@simul_data$drift,
                                                                     decreasing=T,
                                                        index=T)$ix[1]),
                              restrict_ind_low = as.character(sort(bin_time_ar_irt_2pl_abs_sim@simul_data$drift,
                                                                   decreasing=F,
                                                        index=T)$ix[1]),
                               fixtype='constrained',
                              id_diff = sort(bin_time_ar_irt_2pl_abs_sim@simul_data$drift,
                                                  decreasing=T)[1] -
                                sort(bin_time_ar_irt_2pl_abs_sim@simul_data$drift,
                                               decreasing=F)[1],
                              id_diff_high=sort(bin_time_ar_irt_2pl_abs_sim@simul_data$drift,
                                                  decreasing=T)[1],
                             time_sd=10,
                             use_ar=T,
                             person_sd = 1,
                             restrict_sd=.01)
id_plot_rhats(bin_time_ar_irt_2pl_abs_est)
```

```{r irt_2pl_abs_cov_plot}
id_sim_coverage(bin_time_ar_irt_2pl_abs_est) %>% 
  bind_rows(.id='Parameter') %>% 
  ggplot(aes(y=avg,x=Parameter)) +
  stat_summary(fun.args=list(mult=1.96)) + 
  theme_minimal() 
```

```{r irt_2pl_abs_resid}

id_plot_sims(bin_time_ar_irt_2pl_abs_est,type='Residuals')

```

```{r irt_2pl_abs_RMSE}

id_plot_sims(bin_time_ar_irt_2pl_abs_est)

```